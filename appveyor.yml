
image: Visual Studio 2022

clone_depth: 50

environment:
  DEFAULT_BRANCH: main
  SKIP_CI_ON_PUSH: 'true'     # set 'false' if you want pushes to retrigger AppVeyor
  GIT_DEBUG_HTTP: 'false'
  CHOCO_FILE_PATH: tools\chocolateyinstall.ps1

skip_commits:
  message: /(\[ci skip\]|\[skip ci\])/i

init:
  - ps: |
      if ($env:GIT_USER)  { git config --global user.name  $env:GIT_USER }
      if ($env:GIT_EMAIL) { git config --global user.email $env:GIT_EMAIL }
      if (-not (git config --global user.name))  { git config --global user.name  "AppVeyor CI" }
      if (-not (git config --global user.email)) { git config --global user.email "ci@appveyor.local" }

      git config --global core.autocrlf false
      git config --global core.safecrlf false

      if ($env:GIT_DEBUG_HTTP -eq 'true') {
        $env:GIT_TRACE = '1'
        $env:GIT_CURL_VERBOSE = '1'
      }

build_script:
  - ps: |
      $ErrorActionPreference = 'Stop'

      # Robust git invoker: pass args as array, merge stderr for visibility, fail only on non-zero exit
      function Invoke-Git {
        [CmdletBinding()]
        param(
          [Parameter(Mandatory=$true)]
          [string[]]$Arguments,
          [switch]$Quiet
        )
        $prevEap = $ErrorActionPreference
        try {
          $ErrorActionPreference = 'Continue'
          $output = & git @Arguments 2>&1
          if (-not $Quiet) { $output | ForEach-Object { Write-Host $_ } }
          $exit = $LASTEXITCODE
          if ($exit -ne 0) {
            $msg = ($output | Out-String).Trim()
            throw "git $($Arguments -join ' ') failed with exit code $exit`n$msg"
          }
        } finally {
          $ErrorActionPreference = $prevEap
        }
      }

      # Validate required environment variables
      $requiredVars = @('PS_SCRIPT_PATH')
      foreach ($var in $requiredVars) {
          if (-not (Get-Item -Path ("Env:{0}" -f $var) -ErrorAction SilentlyContinue)) {
              throw "Missing required environment variable: $var"
          }
      }
      if (-not $env:URL_X86) {
          throw "Provide the URL_X86 env in AppVeyor UI."
      }

      # Ensure helper script exists
      $helperRel = 'build\Update-ChocoChecksums.ps1'
      $helper = Join-Path $env:APPVEYOR_BUILD_FOLDER $helperRel
      if (-not (Test-Path $helper)) {
          throw "Helper script not found: $helperRel (commit build\Update-ChocoChecksums.ps1 to your repo)."
      }

      # -------------------------------
      # DEBUG: Print helper content to verify it's the corrected file
      # -------------------------------
      Write-Host '=== DEBUG: HEAD of build\Update-ChocoChecksums.ps1 ==='
      Get-Content $helper -First 40 | ForEach-Object { Write-Host $_ }
      Write-Host '=== DEBUG: Lines 220..245 of build\Update-ChocoChecksums.ps1 ==='
      $all = Get-Content $helper
      $start = [Math]::Max(0, [Math]::Min(220, $all.Length - 1))
      $end   = [Math]::Max($start, [Math]::Min(245, $all.Length - 1))
      for ($i = $start; $i -le $end; $i++) { Write-Host ("{0:D4}: {1}" -f $i, $all[$i]) }
      # -------------------------------

      # Run helper to update checksums and nuspec version
      $algo = if ($env:HASH_ALGO) { $env:HASH_ALGO } else { 'sha256' }
      .\build\Update-ChocoChecksums.ps1 -ScriptPath $env:PS_SCRIPT_PATH -Url $env:URL_X86 -Algorithm $algo

      # --- SAFEGUARD: prevent trailing newline being added to tools\chocolateyinstall.ps1 (encoding-safe) ---
      $chocoFileRel = if ($env:CHOCO_FILE_PATH) { $env:CHOCO_FILE_PATH } else { 'tools\chocolateyinstall.ps1' }
      $chocoFile = Join-Path $env:APPVEYOR_BUILD_FOLDER $chocoFileRel
      if (Test-Path $chocoFile) {
        # Read raw bytes to preserve exact encoding/BOM; trim only trailing LF or CRLF if present.
        [byte[]]$bytes = [System.IO.File]::ReadAllBytes($chocoFile)

        if ($bytes.Length -ge 2 -and $bytes[$bytes.Length-2] -eq 13 -and $bytes[$bytes.Length-1] -eq 10) {
          # Trim CRLF (2 bytes)
          $bytes = $bytes[0..($bytes.Length-3)]
          Write-Host "Trimmed trailing CRLF from $chocoFileRel"
        } elseif ($bytes.Length -ge 1 -and $bytes[$bytes.Length-1] -eq 10) {
          # Trim LF (1 byte)
          $bytes = $bytes[0..($bytes.Length-2)]
          Write-Host "Trimmed trailing LF from $chocoFileRel"
        } else {
          Write-Host "No trailing newline to trim in $chocoFileRel"
        }

        [System.IO.File]::WriteAllBytes($chocoFile, $bytes)
      }

      # Commit and push changes if REPO_TOKEN is set
      $repoTokenPresent = ($env:REPO_TOKEN -and $env:REPO_TOKEN.Trim().Length -gt 0)
      if ($repoTokenPresent) {
          if ($env:APPVEYOR_PULL_REQUEST_NUMBER) { return }

          $branch = if ($env:APPVEYOR_REPO_BRANCH) { $env:APPVEYOR_REPO_BRANCH } elseif ($env:DEFAULT_BRANCH) { $env:DEFAULT_BRANCH } else { 'main' }
          git config --global --add safe.directory "$env:APPVEYOR_BUILD_FOLDER"

          # Configure GitHub auth header or fallback to tokenized URL
          $extraHeaderSet = $false
          try {
              $basic = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("x-access-token:$env:REPO_TOKEN"))
              git config --global http.https://github.com/.extraheader ("Authorization: Basic $basic")
              $chk = (& git config --global --get http.https://github.com/.extraheader 2>&1) -join "`n"
              if ($chk) { $extraHeaderSet = $true }
          } catch { }

          # Normalize origin URL
          $origin = ((& git remote get-url origin 2>&1) -join "`n").Trim()
          if ($origin -notmatch '^https://') {
              if ($env:APPVEYOR_REPO_PROVIDER -eq 'gitHub' -and $env:APPVEYOR_REPO_NAME) {
                  $httpsRemote = "https://github.com/$($env:APPVEYOR_REPO_NAME).git"
                  Invoke-Git -Arguments @("remote","set-url","origin",$httpsRemote) -Quiet
              }
          }
          if (-not $extraHeaderSet) {
              if ($env:APPVEYOR_REPO_PROVIDER -eq 'gitHub' -and $env:APPVEYOR_REPO_NAME) {
                  $originTokenized = "https://x-access-token:$($env:REPO_TOKEN)@github.com/$($env:APPVEYOR_REPO_NAME).git"
                  Invoke-Git -Arguments @("remote","set-url","origin",$originTokenized) -Quiet
              }
          }

          # Handle shallow clone
          $isShallow = $false
          try {
              $shallowOut = (& git rev-parse --is-shallow-repository 2>&1) -join "`n"
              if ($shallowOut -match 'true') { $isShallow = $true }
          } catch { }
          if ($isShallow) {
              Invoke-Git -Arguments @("fetch","--unshallow") -Quiet
          }

          # Fetch and checkout branch
          Invoke-Git -Arguments @("fetch","origin",$branch) -Quiet
          $localBranches = (& git branch --list $branch 2>&1) -join "`n"
          if (-not $localBranches) {
              Invoke-Git -Arguments @("checkout","-b",$branch,"origin/$branch") -Quiet
          } else {
              Invoke-Git -Arguments @("checkout","--quiet",$branch) -Quiet
              Invoke-Git -Arguments @("reset","--soft","origin/$branch") -Quiet
          }

          # Stage files (normalize paths to forward slashes)
          $gitPath = ($env:PS_SCRIPT_PATH -replace '\\','/')
          Invoke-Git -Arguments @("add","-f","--",$gitPath) -Quiet
          if (Test-Path "unifiidentity.nuspec") {
              Invoke-Git -Arguments @("add","-f","--","unifiidentity.nuspec") -Quiet
          }
          if (Test-Path $chocoFile) {
              $chocoRelGit = ($chocoFileRel -replace '\\','/')
              Invoke-Git -Arguments @("add","-f","--",$chocoRelGit) -Quiet
          }

          # Commit and push if staged
          $staged = (& git diff --cached --name-only 2>&1) -join "`n"
          if ($staged) {
              $commitMsg = if ($env:SKIP_CI_ON_PUSH -eq 'true') { "Update Chocolatey checksums and nuspec version [ci skip]" } else { "Update Chocolatey checksums and nuspec version" }
              Invoke-Git -Arguments @("commit","-m",$commitMsg)
              Invoke-Git -Arguments @("push","origin","HEAD:$branch") -Quiet
          } else {
              Write-Host "No changes detected to commit."
          }
      }

artifacts:
  - path: tools\chocolateyinstall.ps1
    name: chocolateyinstall.ps1
