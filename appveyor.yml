
image: Visual Studio 2022

clone_depth: 50

environment:
  DEFAULT_BRANCH: main
  SKIP_CI_ON_PUSH: 'true'     # set 'false' if you want pushes to retrigger AppVeyor
  GIT_DEBUG_HTTP: 'false'

skip_commits:
  message: /(\[ci skip\]|\[skip ci\])/i

init:
  - ps: |
      if ($env:GIT_USER)  { git config --global user.name  $env:GIT_USER }
      if ($env:GIT_EMAIL) { git config --global user.email $env:GIT_EMAIL }
      if (-not (git config --global user.name))  { git config --global user.name  "AppVeyor CI" }
      if (-not (git config --global user.email)) { git config --global user.email "ci@appveyor.local" }

      git config --global core.autocrlf false
      git config --global core.safecrlf false

      if ($env:GIT_DEBUG_HTTP -eq 'true') {
        $env:GIT_TRACE = '1'
        $env:GIT_CURL_VERBOSE = '1'
      }

build_script:
  - ps: |
      $ErrorActionPreference = 'Stop'

      # Validate required environment variables
      $requiredVars = @('PS_SCRIPT_PATH')
      foreach ($var in $requiredVars) {
          if (-not (Get-Item -Path ("Env:{0}" -f $var) -ErrorAction SilentlyContinue)) {
              throw "Missing required environment variable: $var"
          }
      }
      if (-not $env:URL_X86 -and -not $env:URL_X64) {
          throw "Provide at least one of URL_X86 or URL_X64 in AppVeyor UI."
      }

      # Ensure helper script exists
      $helperRel = 'build\Update-ChocoChecksums.ps1'
      $helper = Join-Path $env:APPVEYOR_BUILD_FOLDER $helperRel
      if (-not (Test-Path $helper)) {
          throw "Helper script not found: $helperRel (commit build\Update-ChocoChecksums.ps1 to your repo)."
      }

      # -------------------------------
      # DEBUG: Print helper content to verify it's the corrected file
      # -------------------------------
      Write-Host '=== DEBUG: HEAD of build\Update-ChocoChecksums.ps1 ==='
      Get-Content $helper -First 40 | ForEach-Object { Write-Host $_ }
      Write-Host '=== DEBUG: Lines 220..245 of build\Update-ChocoChecksums.ps1 ==='
      $all = Get-Content $helper
      $start = [Math]::Max(0, [Math]::Min(220, $all.Length - 1))
      $end   = [Math]::Max($start, [Math]::Min(245, $all.Length - 1))
      for ($i = $start; $i -le $end; $i++) { Write-Host ("{0:D4}: {1}" -f $i, $all[$i]) }
      # -------------------------------

      # Run helper to update checksums and nuspec version
      $algo = if ($env:HASH_ALGO) { $env:HASH_ALGO } else { 'sha256' }
      .\build\Update-ChocoChecksums.ps1 -ScriptPath $env:PS_SCRIPT_PATH -Url $env:URL_X86 -Url64 $env:URL_X64 -Algorithm $algo

      # Commit and push changes if REPO_TOKEN is set
      $repoTokenPresent = ($env:REPO_TOKEN -and $env:REPO_TOKEN.Trim().Length -gt 0)
      if ($repoTokenPresent) {
          if ($env:APPVEYOR_PULL_REQUEST_NUMBER) { return }

          $branch = if ($env:APPVEYOR_REPO_BRANCH) { $env:APPVEYOR_REPO_BRANCH } elseif ($env:DEFAULT_BRANCH) { $env:DEFAULT_BRANCH } else { 'main' }
          git config --global --add safe.directory "$env:APPVEYOR_BUILD_FOLDER"

          # Configure GitHub auth header or fallback to tokenized URL
          $extraHeaderSet = $false
          try {
              $basic = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("x-access-token:$env:REPO_TOKEN"))
              git config --global http.https://github.com/.extraheader ("Authorization: Basic $basic")
              if (git config --global --get http.https://github.com/.extraheader) { $extraHeaderSet = $true }
          } catch { }

          $origin = (git remote get-url origin)
          if ($origin -notmatch '^https://') {
              if ($env:APPVEYOR_REPO_PROVIDER -eq 'gitHub' -and $env:APPVEYOR_REPO_NAME) {
                  $httpsRemote = "https://github.com/$($env:APPVEYOR_REPO_NAME).git"
                  git remote set-url origin $httpsRemote 2>$null
              }
          }
          if (-not $extraHeaderSet) {
              if ($env:APPVEYOR_REPO_PROVIDER -eq 'gitHub' -and $env:APPVEYOR_REPO_NAME) {
                  $originTokenized = "https://x-access-token:$($env:REPO_TOKEN)@github.com/$($env:APPVEYOR_REPO_NAME).git"
                  git remote set-url origin $originTokenized 2>$null
              }
          }

          # Handle shallow clone
          $isShallow = $false
          try {
              $shallowOut = git rev-parse --is-shallow-repository 2>$null
              if ($shallowOut -match 'true') { $isShallow = $true }
          } catch { }
          if ($isShallow) {
              $prev = $ErrorActionPreference; $ErrorActionPreference = 'Continue'
              git fetch --unshallow 2>$null
              $ErrorActionPreference = $prev
          }

          # Fetch and checkout branch
          $prev = $ErrorActionPreference; $ErrorActionPreference = 'Continue'
          git fetch origin $branch 2>$null
          $ErrorActionPreference = $prev

          $localBranches = git branch --list $branch
          if (-not $localBranches) {
              git checkout -b $branch "origin/$branch" 2>$null
          } else {
              git checkout --quiet $branch 2>$null
              git reset --soft "origin/$branch" 2>$null
          }

          # Explicitly stage both files
          $gitPath = $env:PS_SCRIPT_PATH -replace '\\','/'
          git add -f -- "$gitPath" 2>$null
          if (Test-Path "unifiidentity.nuspec") {
              git add -f -- "unifiidentity.nuspec" 2>$null
          }

          # Commit and push if staged
          $staged = git diff --cached --name-only
          if ($staged) {
              $commitMsg = if ($env:SKIP_CI_ON_PUSH -eq 'true') { "Update Chocolatey checksums and nuspec version [ci skip]" } else { "Update Chocolatey checksums and nuspec version" }
              git commit -m $commitMsg 2>$null

              $prev = $ErrorActionPreference; $ErrorActionPreference = 'Continue'
              & git push origin HEAD:$branch 2>$null
              $code = $LASTEXITCODE
              $ErrorActionPreference = $prev
              if ($code -ne 0) { throw "git push failed with exit code $code" }
          } else {
              Write-Host "No changes detected to commit."
          }
      }

artifacts:
  - path: tools\chocolateyinstall.ps1
    name: chocolateyinstall.ps1
